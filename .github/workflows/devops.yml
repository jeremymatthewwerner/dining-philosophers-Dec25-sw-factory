name: DevOps Agent

on:
  schedule:
    # Run health checks every 5 minutes
    - cron: '*/5 * * * *'
    # Run monitoring audit weekly (Sunday 6am UTC)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - incident-response
          - view-logs
          - restart-service
          - manage-variables
          - provision-infrastructure
          - diagnose
      service:
        description: 'Service name (backend/frontend)'
        type: choice
        options:
          - backend
          - frontend
          - all
        default: 'all'
      severity:
        description: 'Incident severity (for incident-response)'
        type: choice
        options:
          - SEV1
          - SEV2
          - SEV3
        default: 'SEV2'
      description:
        description: 'Description of the issue or action'
        type: string

permissions:
  contents: write
  issues: write
  id-token: write

env:
  FAILURE_THRESHOLD: 2

jobs:
  # ===========================================
  # HEALTH MONITORING (runs every 5 minutes)
  # ===========================================
  smoke-test:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      healthy: ${{ steps.summary.outputs.healthy }}
      failures: ${{ steps.summary.outputs.failures }}

    steps:
      - uses: actions/checkout@v4

      - name: Check backend health endpoint
        id: backend_health
        continue-on-error: true
        run: |
          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            echo "PRODUCTION_BACKEND_URL not set"
            echo "status=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Checking $BACKEND_URL/health..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 "$BACKEND_URL/health" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Backend health check failed: HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Backend health: OK"

      - name: Check frontend loads
        id: frontend
        continue-on-error: true
        run: |
          FRONTEND_URL="${{ secrets.PRODUCTION_FRONTEND_URL }}"
          if [ -z "$FRONTEND_URL" ]; then
            echo "status=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 "$FRONTEND_URL" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Frontend check failed: HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Frontend: OK"

      - name: Test auth flow
        id: auth_test
        continue-on-error: true
        run: |
          BACKEND_URL="${{ secrets.PRODUCTION_BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            echo "status=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          TEST_USER="canary_$(date +%s)_$RANDOM"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BACKEND_URL/api/auth/register" \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$TEST_USER\", \"display_name\": \"Canary\", \"password\": \"canarypass123\"}" \
            --max-time 30 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Auth test failed: HTTP $HTTP_CODE"
            exit 1
          fi
          echo "Auth flow: OK"

      - name: Summarize results
        id: summary
        run: |
          FAILURES=""
          HEALTHY="true"

          [ "${{ steps.backend_health.outcome }}" == "failure" ] && FAILURES="${FAILURES}backend," && HEALTHY="false"
          [ "${{ steps.frontend.outcome }}" == "failure" ] && FAILURES="${FAILURES}frontend," && HEALTHY="false"
          [ "${{ steps.auth_test.outcome }}" == "failure" ] && FAILURES="${FAILURES}auth," && HEALTHY="false"

          FAILURES=$(echo "$FAILURES" | sed 's/,$//')
          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

  # ===========================================
  # INCIDENT CREATION (when health checks fail)
  # ===========================================
  create-incident:
    needs: smoke-test
    if: needs.smoke-test.outputs.healthy == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        continue-on-error: true
        run: |
          # Retry logic for Railway CLI installation (GitHub API can be flaky)
          for attempt in 1 2 3; do
            echo "Railway CLI install attempt $attempt..."
            if curl -fsSL https://railway.app/install.sh | sh; then
              echo "Railway CLI installed successfully"
              break
            fi
            if [ $attempt -lt 3 ]; then
              sleep $((2 ** attempt))
            else
              echo "Warning: Railway CLI installation failed after 3 attempts"
            fi
          done
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Check for existing incident
        id: check_existing
        run: |
          EXISTING=$(gh issue list --label "production-incident" --state open \
            --json number --jq '.[0].number' 2>/dev/null || echo "")
          echo "exists=$( [ -n "$EXISTING" ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "issue_number=$EXISTING" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Collect Railway logs
        id: railway_logs
        continue-on-error: true
        run: |
          # Get last 50 lines of logs from each service
          BACKEND_LOGS=$(railway logs --service backend --limit 50 2>&1 || echo "Unable to fetch backend logs")
          FRONTEND_LOGS=$(railway logs --service frontend --limit 50 2>&1 || echo "Unable to fetch frontend logs")

          echo "backend_logs<<EOF" >> $GITHUB_OUTPUT
          echo "$BACKEND_LOGS" | tail -30 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "frontend_logs<<EOF" >> $GITHUB_OUTPUT
          echo "$FRONTEND_LOGS" | tail -30 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Update or create incident
        run: |
          FAILURES="${{ needs.smoke-test.outputs.failures }}"

          if [ "${{ steps.check_existing.outputs.exists }}" == "true" ]; then
            gh issue comment "${{ steps.check_existing.outputs.issue_number }}" --body "## üîÑ Still Failing

          **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Failed:** $FAILURES
          [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          else
            SEVERITY="SEV2"
            echo "$FAILURES" | grep -q "backend" && SEVERITY="SEV1"

            gh issue create \
              --title "üö® Production Incident: $FAILURES failing" \
              --label "bug,priority-high,production-incident,ai-ready" \
              --body "## üö® Production Incident

          **Severity:** $SEVERITY
          **Failed Checks:** $FAILURES
          **Detected:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### Railway Logs (last 30 lines)

          <details>
          <summary>Backend Logs</summary>

          \`\`\`
          ${{ steps.railway_logs.outputs.backend_logs }}
          \`\`\`
          </details>

          <details>
          <summary>Frontend Logs</summary>

          \`\`\`
          ${{ steps.railway_logs.outputs.frontend_logs }}
          \`\`\`
          </details>

          ### Actions
          - [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Check Railway dashboard for more details
          - Use \`railway logs --service backend\` locally for full logs

          ---
          *Auto-created by DevOps Agent*"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # MANUAL ACTIONS (workflow_dispatch)
  # ===========================================
  manual-action:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        continue-on-error: true
        run: |
          # Retry logic for Railway CLI installation (GitHub API can be flaky)
          for attempt in 1 2 3; do
            echo "Railway CLI install attempt $attempt..."
            if curl -fsSL https://railway.app/install.sh | sh; then
              echo "Railway CLI installed successfully"
              break
            fi
            if [ $attempt -lt 3 ]; then
              sleep $((2 ** attempt))
            else
              echo "Warning: Railway CLI installation failed after 3 attempts"
            fi
          done
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Link Railway project
        continue-on-error: true
        run: |
          # Railway CLI auto-detects project from RAILWAY_TOKEN in CI mode
          railway status || echo "Railway not linked - some features may be limited"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run DevOps Agent
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read CLAUDE.md first.

            ## DevOps Action Request

            **Action:** ${{ github.event.inputs.action }}
            **Service:** ${{ github.event.inputs.service }}
            **Severity:** ${{ github.event.inputs.severity }}
            **Description:** ${{ github.event.inputs.description }}

            ## Available Railway CLI Commands

            You have access to the Railway CLI. Key commands:

            ### Viewing Logs
            ```bash
            railway logs                           # All services
            railway logs --service backend         # Specific service
            railway logs --service frontend
            railway logs --limit 100               # More lines
            railway logs --build                   # Build logs
            ```

            ### Service Management
            ```bash
            railway status                         # Project status
            railway redeploy                       # Redeploy latest
            railway down                           # Remove last deployment (CAREFUL!)
            ```

            ### Environment Variables
            ```bash
            railway variables                      # List all variables
            railway variables --set "KEY=value"    # Set a variable
            railway variables --service backend    # Service-specific vars
            ```

            ### Database Access
            ```bash
            railway connect postgres               # Open psql shell
            ```

            ### Provisioning New Infrastructure
            ```bash
            railway add --database postgres        # Add PostgreSQL
            railway add --database redis           # Add Redis
            railway add --service myservice        # Add empty service
            ```

            ## Action-Specific Instructions

            ### For "incident-response":
            1. Check health endpoints with curl
            2. Get Railway logs: `railway logs --service backend --limit 100`
            3. Look for errors, exceptions, connection issues
            4. Check recent deployments: `gh run list --limit 10`
            5. If code issue: create a fix PR
            6. If infra issue: check Railway dashboard, restart if needed
            7. Document findings in issue comment
            8. Escalate SEV1 to @jeremymatthewwerner

            ### For "view-logs":
            1. Run `railway logs --service ${{ github.event.inputs.service }} --limit 100`
            2. Look for patterns: errors, warnings, slow queries
            3. Summarize findings in a new issue or comment

            ### For "restart-service":
            1. First check current status: `railway status`
            2. Get current logs to document state before restart
            3. Run `railway redeploy` (this deploys the latest successful build)
            4. Wait 60 seconds, then verify health endpoints
            5. Document the restart in an issue comment

            ### For "manage-variables":
            1. List current variables: `railway variables`
            2. If adding/changing: `railway variables --set "KEY=value"`
            3. Document changes (but never log sensitive values!)
            4. Note: Variable changes may require redeploy

            ### For "provision-infrastructure":
            1. ONLY provision if explicitly requested in description
            2. Available: `railway add --database postgres|mysql|redis|mongo`
            3. Document what was provisioned
            4. Update any necessary environment variables
            5. Create issue to track the new resource

            ### For "diagnose":
            1. Check health endpoints using the URLs from environment variables:
               - Backend: $PRODUCTION_BACKEND_URL/health
               - Frontend: $PRODUCTION_FRONTEND_URL
               **IMPORTANT:** Do NOT try to reach custom domains (e.g., diningphilosophers.ai) directly -
               GitHub Actions runners have network restrictions that cause false DNS failures.
               Always use the Railway URLs from the environment variables.
            2. Get logs from all services
            3. Check recent CI runs
            4. Look at recent commits
            5. Check Railway status
            6. Compile a diagnostic report

            ## Important Rules

            - NEVER expose secrets or tokens in logs/comments
            - Document all actions taken in GitHub issues
            - For destructive actions (railway down), confirm twice and document
            - Escalate to human for: security issues, data loss risk, unclear situations
            - After any fix, verify health endpoints are working

          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --dangerously-skip-permissions
            --allowedTools "Bash(railway:*),Bash(gh:*),Bash(curl:*),Bash(git:*),Read,Glob,Grep"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          PRODUCTION_BACKEND_URL: ${{ secrets.PRODUCTION_BACKEND_URL }}
          PRODUCTION_FRONTEND_URL: ${{ secrets.PRODUCTION_FRONTEND_URL }}

  # ===========================================
  # WEEKLY MONITORING AUDIT (ensures completeness)
  # ===========================================
  monitoring-audit:
    if: github.event_name == 'schedule' && github.event.schedule == '0 6 * * 0'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        continue-on-error: true
        run: |
          # Retry logic for Railway CLI installation (GitHub API can be flaky)
          for attempt in 1 2 3; do
            echo "Railway CLI install attempt $attempt..."
            if curl -fsSL https://railway.app/install.sh | sh; then
              echo "Railway CLI installed successfully"
              break
            fi
            if [ $attempt -lt 3 ]; then
              sleep $((2 ** attempt))
            else
              echo "Warning: Railway CLI installation failed after 3 attempts"
            fi
          done
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Run Monitoring Audit
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            Read CLAUDE.md first.

            ## Weekly Monitoring & Dashboard Audit

            Your task is to audit the monitoring and observability setup and ensure it's complete.

            ### Audit Checklist

            1. **Health Endpoints**
               - Check all services have /health endpoints responding
               - Verify health check frequency is appropriate (every 5 min)
               - Ensure health checks cover critical dependencies (DB, cache, etc.)

            2. **Logging**
               - Run `railway logs --service backend --limit 50` and `railway logs --service frontend --limit 50`
               - Check logs have proper structure (timestamps, levels, context)
               - Look for any recurring errors that need attention

            3. **Alerting**
               - Review existing GitHub issues labeled `production-incident`
               - Check if incidents are being created when health checks fail
               - Verify escalation path is documented in CLAUDE.md

            4. **Dashboard Completeness**
               - Check Railway dashboard has all services visible
               - Verify environment variables are properly set
               - Review recent deployments for any failures

            5. **Documentation**
               - Ensure CLAUDE.md has accurate runbook for common issues
               - Verify DevOps section documents all available actions
               - Check secrets list is complete

            ### Actions to Take

            - If monitoring gaps found: Create GitHub issue with `monitoring` label
            - If dashboard incomplete: Document what's missing in an issue
            - If alerts missing: Update devops.yml or create issue
            - If everything OK: Create brief status comment on tracking issue (if exists)

            ### Output

            Create a GitHub issue titled "üìä Weekly Monitoring Audit - [DATE]" with:
            - Summary of audit findings
            - List of any gaps or issues found
            - Recommendations for improvements
            - Status: ‚úÖ Complete / ‚ö†Ô∏è Needs Attention / ‚ùå Critical Issues

          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --dangerously-skip-permissions
            --allowedTools "Bash(railway:*),Bash(gh:*),Bash(curl:*),Read,Glob,Grep"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
