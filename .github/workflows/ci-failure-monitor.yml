name: CI Failure Monitor

on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  create-issue-on-failure:
    runs-on: ubuntu-latest
    # Only run if CI failed on main branch (not PRs - those are expected to potentially fail)
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: Get failed jobs info and logs
        id: failed-jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching failed jobs for run ${{ github.event.workflow_run.id }}"

          FAILED_JOBS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")' || echo "Unknown")

          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT

          # Get the run URL
          echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT

          # CRITICAL: Capture actual failure logs so Code Agent has context
          echo "Fetching failure logs..."
          FAILURE_LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log-failed 2>/dev/null | tail -200 || echo "Could not fetch logs")

          # Store logs (truncated to avoid GitHub API limits)
          echo "failure_logs<<LOGS_EOF" >> $GITHUB_OUTPUT
          echo "${FAILURE_LOGS:0:10000}" >> $GITHUB_OUTPUT
          echo "LOGS_EOF" >> $GITHUB_OUTPUT

      - name: Check for existing issue
        id: check-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for open issues with the CI failure label for this commit
          EXISTING=$(gh issue list --repo ${{ github.repository }} \
            --label "ci-failure" \
            --state open \
            --search "CI Failure on main" \
            --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$EXISTING" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for CI failure
        id: create-issue
        if: steps.check-issue.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAILURE_LOGS: ${{ steps.failed-jobs.outputs.failure_logs }}
        run: |
          # Create issue WITHOUT ai-ready label first
          ISSUE_URL=$(gh issue create --repo ${{ github.repository }} \
            --title "CI Failure on main: ${{ steps.failed-jobs.outputs.failed_jobs }}" \
            --label "bug,priority-high,ci-failure" \
            --body "## CI Pipeline Failed on Main Branch

          **Failed Jobs:** ${{ steps.failed-jobs.outputs.failed_jobs }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          **Branch:** main
          **Run:** ${{ steps.failed-jobs.outputs.run_url }}

          ## Failure Logs

          <details>
          <summary>ðŸ“‹ Click to expand failure logs</summary>

          \`\`\`
          ${FAILURE_LOGS}
          \`\`\`

          </details>

          ## Instructions for Code Agent

          1. **Read the failure logs above first** - they show exactly what went wrong
          2. Identify the root cause from the error messages
          3. Fix the issue and create a PR
          4. Ensure all tests pass before merging

          ## Context

          This issue was automatically created because the CI/CD pipeline failed on the main branch.
          The failure needs immediate attention to restore the build.

          ---
          *Auto-generated by CI Failure Monitor*")

          # Extract issue number
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Created issue #$ISSUE_NUMBER"

      # Add ai-ready label separately to trigger Code Agent's labeled event
      - name: Trigger Code Agent
        if: steps.check-issue.outputs.exists == 'false' && steps.create-issue.outputs.issue_number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Adding ai-ready label to trigger Code Agent..."
          gh issue edit ${{ steps.create-issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-label "ai-ready"

      - name: Update existing issue
        if: steps.check-issue.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.check-issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "## Another CI Failure Detected

          **Failed Jobs:** ${{ steps.failed-jobs.outputs.failed_jobs }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          **Run:** ${{ steps.failed-jobs.outputs.run_url }}

          The CI is still failing. Please investigate."
