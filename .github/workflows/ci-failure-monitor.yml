name: CI Failure Monitor

on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  create-issue-on-failure:
    runs-on: ubuntu-latest
    # Only run if CI failed on main branch (not PRs - those are expected to potentially fail)
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: Get failed jobs info
        id: failed-jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching failed jobs for run ${{ github.event.workflow_run.id }}"

          FAILED_JOBS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")' || echo "Unknown")

          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT

          # Get the run URL
          echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT

      - name: Check for existing issue
        id: check-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for open issues with the CI failure label for this commit
          EXISTING=$(gh issue list --repo ${{ github.repository }} \
            --label "ci-failure" \
            --state open \
            --search "CI Failure on main" \
            --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$EXISTING" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for CI failure
        if: steps.check-issue.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create --repo ${{ github.repository }} \
            --title "CI Failure on main: ${{ steps.failed-jobs.outputs.failed_jobs }}" \
            --label "bug,ai-ready,priority-high,ci-failure" \
            --body "## CI Pipeline Failed on Main Branch

          **Failed Jobs:** ${{ steps.failed-jobs.outputs.failed_jobs }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          **Branch:** main
          **Run:** ${{ steps.failed-jobs.outputs.run_url }}

          ## Instructions for Code Agent

          1. Check the failed workflow run logs at the URL above
          2. Identify the root cause of the failure
          3. Fix the issue and create a PR
          4. Ensure all tests pass before merging

          ## Context

          This issue was automatically created because the CI/CD pipeline failed on the main branch.
          The failure needs immediate attention to restore the build.

          ---
          *Auto-generated by CI Failure Monitor*"

      - name: Update existing issue
        if: steps.check-issue.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.check-issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "## Another CI Failure Detected

          **Failed Jobs:** ${{ steps.failed-jobs.outputs.failed_jobs }}
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          **Run:** ${{ steps.failed-jobs.outputs.run_url }}

          The CI is still failing. Please investigate."
